<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IUT Iftar â€” Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Instrument+Serif:ital@0;1&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --bg:      #0d1117;
      --panel:   #161b22;
      --border:  #30363d;
      --text:    #e6edf3;
      --muted:   #7d8590;
      --green:   #3fb950;
      --red:     #f85149;
      --amber:   #d29922;
      --blue:    #58a6ff;
      --purple:  #bc8cff;
    }

    body {
      font-family: 'Space Mono', monospace;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
    }

    /* â”€â”€ TOP NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    nav {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 28px;
      border-bottom: 1px solid var(--border);
      position: sticky; top: 0; background: var(--bg); z-index: 100;
    }
    .nav-logo {
      font-size: 14px; font-weight: 700; letter-spacing: 0.05em;
    }
    .nav-logo em {
      color: var(--green); font-style: normal;
    }
    .nav-right { display: flex; align-items: center; gap: 20px; }
    .nav-clock {
      font-size: 12px; color: var(--muted); letter-spacing: 0.05em;
    }
    .nav-status {
      display: flex; align-items: center; gap: 7px;
      font-size: 11px; color: var(--muted);
    }
    .live-dot {
      width: 7px; height: 7px; border-radius: 50%;
      background: var(--green);
      animation: blink 1.5s infinite;
    }
    @keyframes blink { 0%,100% { opacity:1; } 50% { opacity:0.3; } }

    /* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .dashboard {
      padding: 24px 28px;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      grid-template-rows: auto;
      gap: 16px;
    }

    .panel {
      background: var(--panel);
      border: 1px solid var(--border);
      padding: 20px;
    }
    .panel-title {
      font-size: 10px; letter-spacing: 0.15em;
      text-transform: uppercase; color: var(--muted);
      margin-bottom: 18px; display: flex; align-items: center; gap: 8px;
    }
    .panel-title::before {
      content: ''; width: 3px; height: 12px;
      background: var(--blue); display: block;
    }

    /* span full width */
    .span-3 { grid-column: 1 / 4; }
    .span-2 { grid-column: 1 / 3; }

    /* â”€â”€ HEALTH GRID â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .services-grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 12px;
    }
    .svc-card {
      border: 1px solid var(--border);
      padding: 16px 12px;
      text-align: center;
      transition: border-color 0.3s;
      cursor: default;
    }
    .svc-card.healthy { border-color: rgba(63,185,80,0.4); }
    .svc-card.degraded { border-color: rgba(210,153,34,0.4); }
    .svc-card.down  { border-color: rgba(248,81,73,0.5); }

    .svc-icon { font-size: 22px; margin-bottom: 8px; }
    .svc-name { font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); margin-bottom: 8px; }
    .svc-status-dot {
      width: 10px; height: 10px; border-radius: 50%;
      margin: 0 auto 8px;
      transition: background 0.4s;
    }
    .svc-card.healthy  .svc-status-dot { background: var(--green); box-shadow: 0 0 8px rgba(63,185,80,0.5); }
    .svc-card.degraded .svc-status-dot { background: var(--amber); box-shadow: 0 0 8px rgba(210,153,34,0.5); }
    .svc-card.down     .svc-status-dot { background: var(--red);   box-shadow: 0 0 8px rgba(248,81,73,0.5); }
    .svc-label {
      font-size: 9px; text-transform: uppercase; letter-spacing: 0.08em;
    }
    .svc-card.healthy  .svc-label { color: var(--green); }
    .svc-card.degraded .svc-label { color: var(--amber); }
    .svc-card.down     .svc-label { color: var(--red); }
    .svc-latency { font-size: 9px; color: var(--muted); margin-top: 4px; }

    /* â”€â”€ METRICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .metrics-row {
      display: grid; grid-template-columns: repeat(4, 1fr);
      gap: 12px; margin-bottom: 0;
    }
    .metric-box { border: 1px solid var(--border); padding: 16px 14px; }
    .metric-val {
      font-size: 28px; font-weight: 700; letter-spacing: -0.02em;
      line-height: 1; margin-bottom: 4px;
    }
    .metric-val.green  { color: var(--green); }
    .metric-val.red    { color: var(--red); }
    .metric-val.amber  { color: var(--amber); }
    .metric-val.blue   { color: var(--blue); }
    .metric-label { font-size: 9px; letter-spacing: 0.1em; text-transform: uppercase; color: var(--muted); }
    .metric-delta { font-size: 10px; color: var(--muted); margin-top: 6px; }

    /* â”€â”€ LIVE CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chart-area {
      position: relative; height: 100px;
      overflow: hidden;
    }
    canvas#latencyChart { width: 100%; height: 100%; }

    .chart-legend {
      display: flex; gap: 16px; margin-top: 10px;
    }
    .legend-item { display: flex; align-items: center; gap: 6px; font-size: 9px; color: var(--muted); }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

    .chart-alert {
      display: none;
      margin-top: 12px; padding: 10px 14px;
      border: 1px solid var(--red);
      background: rgba(248,81,73,0.08);
      font-size: 11px; color: var(--red);
      animation: flash 1s infinite;
    }
    .chart-alert.show { display: flex; align-items: center; gap: 10px; }
    @keyframes flash { 0%,100%{opacity:1;} 50%{opacity:0.6;} }

    /* â”€â”€ ORDER LOG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .log-list {
      max-height: 240px; overflow-y: auto;
    }
    .log-list::-webkit-scrollbar { width: 3px; }
    .log-list::-webkit-scrollbar-thumb { background: var(--border); }

    .log-entry {
      display: flex; align-items: center; gap: 10px;
      padding: 9px 0; border-bottom: 1px solid var(--border);
      font-size: 11px; animation: slideIn 0.3s ease;
    }
    .log-entry:last-child { border-bottom: none; }
    @keyframes slideIn { from { opacity:0; transform:translateX(-10px); } to { opacity:1; transform:none; } }
    .log-time { color: var(--muted); width: 70px; flex-shrink: 0; }
    .log-id   { color: var(--blue); width: 100px; flex-shrink: 0; }
    .log-status {
      padding: 2px 8px; font-size: 9px; letter-spacing: 0.08em;
      border-radius: 0; flex-shrink: 0;
    }
    .log-status.pending  { background: rgba(210,153,34,0.15); color: var(--amber); }
    .log-status.stock    { background: rgba(88,166,255,0.15); color: var(--blue); }
    .log-status.kitchen  { background: rgba(188,140,255,0.15); color: var(--purple); }
    .log-status.ready    { background: rgba(63,185,80,0.15); color: var(--green); }
    .log-status.failed   { background: rgba(248,81,73,0.15); color: var(--red); }
    .log-item { color: var(--muted); font-size: 10px; }

    /* â”€â”€ CHAOS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chaos-panel { border: 1px solid rgba(248,81,73,0.3); }
    .chaos-panel .panel-title::before { background: var(--red); }
    .chaos-warning {
      font-size: 10px; color: var(--red);
      border: 1px solid rgba(248,81,73,0.3);
      padding: 8px 12px; margin-bottom: 16px;
      background: rgba(248,81,73,0.05);
    }
    .chaos-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; }
    .chaos-btn {
      background: transparent; border: 1px solid var(--border);
      color: var(--text); font-family: 'Space Mono', monospace;
      font-size: 10px; letter-spacing: 0.05em;
      padding: 12px 8px; cursor: pointer; text-align: center;
      transition: all 0.2s;
    }
    .chaos-btn:hover { border-color: var(--red); color: var(--red); }
    .chaos-btn.killed {
      border-color: var(--red); background: rgba(248,81,73,0.1);
      color: var(--red);
    }
    .chaos-btn.killed:hover { background: rgba(248,81,73,0.2); }
    .chaos-btn-icon { font-size: 16px; margin-bottom: 6px; }
    .chaos-btn-name { display: block; }
    .chaos-btn-state { display: block; font-size: 9px; margin-top: 3px; }
    .chaos-btn.killed .chaos-btn-state { color: var(--red); }
    .chaos-btn:not(.killed) .chaos-btn-state { color: var(--green); }

    /* â”€â”€ THROUGHPUT BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .tput-bars {
      display: flex; align-items: flex-end; gap: 3px;
      height: 60px;
    }
    .tput-bar {
      flex: 1; background: rgba(63,185,80,0.3);
      border-top: 1px solid var(--green);
      transition: height 0.3s;
    }
    .tput-bar.hot { background: rgba(210,153,34,0.3); border-top-color: var(--amber); }
    .tput-bar.peak { background: rgba(248,81,73,0.3); border-top-color: var(--red); }

    /* â”€â”€ ALERT BANNER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    #alertBanner {
      display: none; position: fixed; top: 56px; left: 0; right: 0;
      background: rgba(248,81,73,0.95); color: #fff;
      padding: 10px 28px; font-size: 12px; letter-spacing: 0.05em;
      z-index: 200; text-align: center;
      animation: slideDown 0.3s ease;
    }
    #alertBanner.show { display: block; }
    @keyframes slideDown { from { transform:translateY(-100%); } to { transform:translateY(0); } }
  </style>
</head>
<body>

<div id="alertBanner">âš  ALERT â€” Gateway avg latency exceeded 1000ms over last 30s window!</div>

<nav>
  <div class="nav-logo">IUT IFTAR <em>// ADMIN</em></div>
  <div class="nav-right">
    <div class="nav-status"><div class="live-dot"></div> LIVE</div>
    <div class="nav-clock" id="navClock">--:--:--</div>
  </div>
</nav>

<div class="dashboard">

  <!-- â”€â”€ ROW 1: Metrics (span 3) â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="panel span-3">
    <div class="panel-title">System Metrics</div>
    <div class="metrics-row">
      <div class="metric-box">
        <div class="metric-val green" id="m-total">0</div>
        <div class="metric-label">Total Orders</div>
        <div class="metric-delta" id="m-total-rate">+0/min</div>
      </div>
      <div class="metric-box">
        <div class="metric-val red" id="m-failed">0</div>
        <div class="metric-label">Failures (5xx)</div>
        <div class="metric-delta" id="m-fail-rate">0% rate</div>
      </div>
      <div class="metric-box">
        <div class="metric-val amber" id="m-latency">â€”</div>
        <div class="metric-label">Avg Gateway Latency</div>
        <div class="metric-delta" id="m-latency-status">Normal</div>
      </div>
      <div class="metric-box">
        <div class="metric-val blue" id="m-active">0</div>
        <div class="metric-label">Active Orders</div>
        <div class="metric-delta" id="m-queue">0 in kitchen queue</div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ ROW 2: Health Grid (span 3) â”€â”€ -->
  <div class="panel span-3">
    <div class="panel-title">Service Health</div>
    <div class="services-grid" id="servicesGrid">
      <!-- rendered by JS -->
    </div>
  </div>

  <!-- â”€â”€ ROW 3: Latency Chart (span 2) + Throughput -->
  <div class="panel span-2">
    <div class="panel-title">Gateway Latency (last 60s)</div>
    <div class="chart-area">
      <canvas id="latencyChart"></canvas>
    </div>
    <div class="chart-legend">
      <div class="legend-item"><div class="legend-dot" style="background:var(--blue)"></div>avg latency</div>
      <div class="legend-item"><div class="legend-dot" style="background:var(--red)"></div>1000ms threshold</div>
    </div>
    <div class="chart-alert" id="latencyAlert">
      âš¡ High latency detected! Gateway averaging >1s.
    </div>
  </div>

  <div class="panel">
    <div class="panel-title">Throughput / 5s</div>
    <div class="tput-bars" id="tputBars"></div>
    <div style="font-size:9px;color:var(--muted);margin-top:8px;">Orders processed per 5-second window (last 20 buckets)</div>
  </div>

  <!-- â”€â”€ ROW 4: Order Log (span 2) + Chaos -->
  <div class="panel span-2">
    <div class="panel-title">Live Order Feed</div>
    <div class="log-list" id="logList">
      <div style="font-size:11px;color:var(--muted);padding:12px 0;">No orders yet. Waiting for first Iftar rush...</div>
    </div>
  </div>

  <div class="panel chaos-panel">
    <div class="panel-title">Chaos Engineering</div>
    <div class="chaos-warning">âš  Killing a service simulates real failure. Observe UI & system resilience.</div>
    <div class="chaos-grid" id="chaosGrid">
      <!-- rendered by JS -->
    </div>
  </div>

</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG â€” match your backend ports
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const API = {
  identity: 'http://localhost:5001',
  gateway:  'http://localhost:5002',
  stock:    'http://localhost:5003',
  kitchen:  'http://localhost:5004',
  notif:    'http://localhost:5005',
};

const SERVICES = [
  { id: 'identity', name: 'Identity',      emoji: 'ğŸ”', healthUrl: `${API.identity}/health`,  metricsUrl: `${API.identity}/metrics`  },
  { id: 'gateway',  name: 'Order Gateway', emoji: 'ğŸšª', healthUrl: `${API.gateway}/health`,   metricsUrl: `${API.gateway}/metrics`   },
  { id: 'stock',    name: 'Stock Service', emoji: 'ğŸ“¦', healthUrl: `${API.stock}/health`,     metricsUrl: `${API.stock}/metrics`     },
  { id: 'kitchen',  name: 'Kitchen Queue', emoji: 'ğŸ‘¨â€ğŸ³', healthUrl: `${API.kitchen}/health`,   metricsUrl: `${API.kitchen}/metrics`   },
  { id: 'notif',    name: 'Notif Hub',     emoji: 'ğŸ“¡', healthUrl: `${API.notif}/health`,     metricsUrl: `${API.notif}/metrics`     },
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATE */
const state = {
  totalOrders: 0, failedOrders: 0, activeOrders: 0, kitchenQueue: 0,
  latencyHistory: new Array(60).fill(null),
  tputHistory:    new Array(20).fill(0),
  tputBucket:     0,
  killedServices: new Set(),
  latencyWindow:  [], // for 30s alert
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INIT */
window.addEventListener('DOMContentLoaded', () => {
  renderServiceCards();
  renderChaosGrid();
  renderTputBars();
  initCanvas();
  tick();          // start all polling
  clockTick();
  setInterval(clockTick, 1000);
  setInterval(tick, 3000);
  setInterval(latencyTick, 1000);
  setInterval(tputTick, 5000);
  setInterval(checkLatencyAlert, 5000);
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CLOCK */
function clockTick() {
  document.getElementById('navClock').textContent =
    new Date().toLocaleTimeString('en-BD', { hour12: false });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• SERVICE CARDS */
function renderServiceCards() {
  const grid = document.getElementById('servicesGrid');
  grid.innerHTML = '';
  SERVICES.forEach(svc => {
    const card = document.createElement('div');
    card.className = 'svc-card';
    card.id = 'svc-' + svc.id;
    card.innerHTML = `
      <div class="svc-icon">${svc.emoji}</div>
      <div class="svc-name">${svc.name}</div>
      <div class="svc-status-dot"></div>
      <div class="svc-label">Checkingâ€¦</div>
      <div class="svc-latency" id="svclatency-${svc.id}">â€”</div>
    `;
    grid.appendChild(card);
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• CHAOS GRID */
function renderChaosGrid() {
  const grid = document.getElementById('chaosGrid');
  grid.innerHTML = '';
  SERVICES.forEach(svc => {
    const btn = document.createElement('button');
    btn.className = 'chaos-btn';
    btn.id = 'chaos-' + svc.id;
    btn.innerHTML = `
      <div class="chaos-btn-icon">${svc.emoji}</div>
      <span class="chaos-btn-name">${svc.name}</span>
      <span class="chaos-btn-state" id="chaosstate-${svc.id}">â— ONLINE</span>
    `;
    btn.onclick = () => toggleChaos(svc);
    grid.appendChild(btn);
  });
}

async function toggleChaos(svc) {
  const isKilled = state.killedServices.has(svc.id);
  const action   = isKilled ? 'revive' : 'kill';
  const btn      = document.getElementById('chaos-' + svc.id);
  const stateEl  = document.getElementById('chaosstate-' + svc.id);

  // Try actual kill/revive endpoint
  try {
    await fetch(`${API.gateway}/admin/chaos`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ service: svc.id, action }),
    });
  } catch(e) { /* endpoint might not exist; simulate locally */ }

  if (isKilled) {
    state.killedServices.delete(svc.id);
    btn.classList.remove('killed');
    stateEl.textContent = 'â— ONLINE';
    updateServiceCard(svc.id, 'healthy', 0);
  } else {
    state.killedServices.add(svc.id);
    btn.classList.add('killed');
    stateEl.textContent = 'âœ— KILLED';
    updateServiceCard(svc.id, 'down', 0);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HEALTH POLLING */
async function tick() {
  for (const svc of SERVICES) {
    if (state.killedServices.has(svc.id)) continue; // respect chaos
    const t0 = Date.now();
    try {
      const res = await fetch(svc.healthUrl, { signal: AbortSignal.timeout(2000) });
      const ms  = Date.now() - t0;
      const status = res.ok ? 'healthy' : 'degraded';
      updateServiceCard(svc.id, status, ms);

      // pull metrics
      try {
        const mres  = await fetch(svc.metricsUrl, { signal: AbortSignal.timeout(2000) });
        if (mres.ok) {
          const metrics = await mres.json();
          ingestMetrics(svc.id, metrics);
        }
      } catch(_) {}

    } catch(e) {
      updateServiceCard(svc.id, 'down', 0);
    }
  }
  updateMetricsUI();
}

function updateServiceCard(id, status, latencyMs) {
  const card = document.getElementById('svc-' + id);
  if (!card) return;
  card.className = `svc-card ${status}`;
  card.querySelector('.svc-label').textContent = status.toUpperCase();
  const latEl = document.getElementById('svclatency-' + id);
  latEl.textContent = latencyMs > 0 ? latencyMs + 'ms' : 'â€”';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• METRICS INGESTION */
function ingestMetrics(serviceId, metrics) {
  /*
   Expected shape from backend /metrics:
   {
     total_orders:    number,
     failed_orders:   number,
     active_orders:   number,
     kitchen_queue:   number,
     avg_latency_ms:  number,
   }
  */
  if (metrics.total_orders  !== undefined) state.totalOrders  = metrics.total_orders;
  if (metrics.failed_orders !== undefined) state.failedOrders = metrics.failed_orders;
  if (metrics.active_orders !== undefined) state.activeOrders = metrics.active_orders;
  if (metrics.kitchen_queue !== undefined) state.kitchenQueue = metrics.kitchen_queue;
  if (serviceId === 'gateway' && metrics.avg_latency_ms !== undefined) {
    pushLatency(metrics.avg_latency_ms);
  }
  // Also ingest live order log events if present
  if (Array.isArray(metrics.recent_orders)) {
    metrics.recent_orders.forEach(appendLogEntry);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• METRICS UI */
let lastTotal = 0;
function updateMetricsUI() {
  document.getElementById('m-total').textContent   = state.totalOrders;
  document.getElementById('m-failed').textContent  = state.failedOrders;
  document.getElementById('m-active').textContent  = state.activeOrders;

  const rate = state.totalOrders - lastTotal;
  lastTotal  = state.totalOrders;
  document.getElementById('m-total-rate').textContent =
    `+${rate}/cycle`;
  document.getElementById('m-fail-rate').textContent =
    state.totalOrders > 0
      ? ((state.failedOrders / state.totalOrders) * 100).toFixed(1) + '% rate'
      : '0% rate';
  document.getElementById('m-queue').textContent = `${state.kitchenQueue} in kitchen queue`;

  const latArr = state.latencyHistory.filter(v => v !== null);
  const avg = latArr.length ? Math.round(latArr.slice(-10).reduce((a,b)=>a+b,0) / Math.min(latArr.length,10)) : null;
  document.getElementById('m-latency').textContent = avg ? avg + 'ms' : 'â€”';
  const latStatus = document.getElementById('m-latency-status');
  if (avg === null) { latStatus.textContent = 'No data'; latStatus.style.color = 'var(--muted)'; }
  else if (avg > 1000) { latStatus.textContent = 'âš  High latency!'; latStatus.style.color = 'var(--red)'; }
  else if (avg > 500)  { latStatus.textContent = 'Elevated'; latStatus.style.color = 'var(--amber)'; }
  else                 { latStatus.textContent = 'Normal'; latStatus.style.color = 'var(--green)'; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LATENCY CHART */
let ctx = null;
function initCanvas() {
  const canvas = document.getElementById('latencyChart');
  canvas.width  = canvas.offsetWidth  || 400;
  canvas.height = canvas.offsetHeight || 100;
  ctx = canvas.getContext('2d');
}

let latencySimInterval = null;
function pushLatency(ms) {
  state.latencyHistory.shift();
  state.latencyHistory.push(ms);
  state.latencyWindow.push({ ms, time: Date.now() });
  drawChart();
}

function latencyTick() {
  // If no real data, keep chart alive with a simulated heartbeat baseline
  const latArr = state.latencyHistory.filter(v => v !== null);
  if (latArr.length === 0) {
    // simulate baseline ~120ms with spikes during ordering
    const sim = 80 + Math.random() * 60;
    pushLatency(Math.round(sim));
  }
  drawChart();
}

function drawChart() {
  if (!ctx) return;
  const W = ctx.canvas.width;
  const H = ctx.canvas.height;
  ctx.clearRect(0, 0, W, H);

  const data  = state.latencyHistory;
  const valid = data.filter(v => v !== null);
  const max   = Math.max(1200, ...valid) * 1.1;
  const step  = W / (data.length - 1);

  // threshold line at 1000ms
  const threshY = H - (1000 / max) * H;
  ctx.setLineDash([4, 4]);
  ctx.strokeStyle = 'rgba(248,81,73,0.4)';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(0, threshY); ctx.lineTo(W, threshY); ctx.stroke();
  ctx.setLineDash([]);

  // gradient fill
  const grad = ctx.createLinearGradient(0, 0, 0, H);
  grad.addColorStop(0, 'rgba(88,166,255,0.3)');
  grad.addColorStop(1, 'rgba(88,166,255,0)');

  // draw line
  ctx.beginPath();
  let started = false;
  const points = [];
  data.forEach((v, i) => {
    if (v === null) return;
    const x = i * step;
    const y = H - (v / max) * H;
    points.push({ x, y });
    if (!started) { ctx.moveTo(x, y); started = true; }
    else ctx.lineTo(x, y);
  });

  ctx.strokeStyle = 'rgba(88,166,255,0.9)';
  ctx.lineWidth = 2;
  ctx.stroke();

  // fill
  if (points.length >= 2) {
    ctx.lineTo(points[points.length-1].x, H);
    ctx.lineTo(points[0].x, H);
    ctx.closePath();
    ctx.fillStyle = grad;
    ctx.fill();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LATENCY ALERT (30s window) */
function checkLatencyAlert() {
  const now = Date.now();
  state.latencyWindow = state.latencyWindow.filter(e => now - e.time < 30000);
  if (state.latencyWindow.length < 5) return;
  const avg = state.latencyWindow.reduce((s,e) => s + e.ms, 0) / state.latencyWindow.length;
  const alertEl     = document.getElementById('latencyAlert');
  const bannerEl    = document.getElementById('alertBanner');
  if (avg > 1000) {
    alertEl.classList.add('show');
    bannerEl.classList.add('show');
    setTimeout(() => bannerEl.classList.remove('show'), 8000);
  } else {
    alertEl.classList.remove('show');
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• THROUGHPUT BARS */
function renderTputBars() {
  const el = document.getElementById('tputBars');
  el.innerHTML = '';
  const max = Math.max(1, ...state.tputHistory);
  state.tputHistory.forEach(v => {
    const bar = document.createElement('div');
    const pct = max > 0 ? (v / max) * 100 : 0;
    bar.className = 'tput-bar' + (pct > 80 ? ' peak' : pct > 50 ? ' hot' : '');
    bar.style.height = pct + '%';
    el.appendChild(bar);
  });
}

function tputTick() {
  state.tputHistory.shift();
  state.tputHistory.push(state.tputBucket);
  state.tputBucket = 0;
  renderTputBars();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• ORDER LOG */
function appendLogEntry(order) {
  const list = document.getElementById('logList');
  const empty = list.querySelector('div[style]');
  if (empty) empty.remove();

  // Increment counters
  state.totalOrders++;
  state.tputBucket++;
  if (order.status === 'failed') state.failedOrders++;

  const statusMap = {
    'pending': 'pending', 'PENDING': 'pending',
    'stock_verified': 'stock', 'STOCK_VERIFIED': 'stock',
    'in_kitchen': 'kitchen', 'IN_KITCHEN': 'kitchen',
    'ready': 'ready', 'READY': 'ready',
    'failed': 'failed', 'FAILED': 'failed',
  };
  const cls   = statusMap[order.status] || 'pending';
  const label = order.status?.replace(/_/g,' ') || 'PENDING';

  const entry = document.createElement('div');
  entry.className = 'log-entry';
  entry.innerHTML = `
    <span class="log-time">${new Date().toLocaleTimeString('en-BD', {hour:'2-digit',minute:'2-digit',second:'2-digit'})}</span>
    <span class="log-id">${(order.orderId || 'ORD-????').slice(0,12)}</span>
    <span class="log-status ${cls}">${label}</span>
    <span class="log-item">${order.itemId || 'â€”'}</span>
  `;

  // insert at top
  list.insertBefore(entry, list.firstChild);

  // keep max 50 entries
  while (list.children.length > 50) list.removeChild(list.lastChild);

  updateMetricsUI();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WEBSOCKET for live events */
function connectAdminWS() {
  const token = localStorage.getItem('iut_token');
  if (!token) return;
  try {
    const ws = new WebSocket(`ws://localhost:5005/admin?token=${token}`);
    ws.onmessage = e => {
      try {
        const msg = JSON.parse(e.data);
        // Expect: { type: 'ORDER_EVENT', orderId, status, itemId }
        if (msg.type === 'ORDER_EVENT') appendLogEntry(msg);
        // { type: 'METRICS', ... } â†’ ingestMetrics('gateway', msg)
        if (msg.type === 'METRICS') ingestMetrics('gateway', msg);
      } catch(_) {}
    };
    ws.onerror = () => {}; // silent; polling handles it
  } catch(_) {}
}
connectAdminWS();
</script>
</body>
</html>