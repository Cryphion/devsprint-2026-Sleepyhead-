<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>IUT Iftar â€” Student Portal</title>
  <link href="https://fonts.googleapis.com/css2?family=Bricolage+Grotesque:wght@400;600;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet"/>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg:       #f5f0e8;
      --surface:  #fefcf7;
      --border:   #d6cebc;
      --ink:      #1a1612;
      --muted:    #8a7e6e;
      --accent:   #c84b2f;
      --gold:     #d4860a;
      --green:    #2a7a4b;
      --amber:    #e09a1a;
      --shadow:   rgba(26,22,18,0.12);
    }

    body {
      font-family: 'Bricolage Grotesque', sans-serif;
      background: var(--bg);
      color: var(--ink);
      min-height: 100vh;
    }

    /* Noise texture overlay */
    body::before {
      content: '';
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)' opacity='0.04'/%3E%3C/svg%3E");
      pointer-events: none; z-index: 9999; opacity: 0.5;
    }

    /* â”€â”€ HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 20px 40px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
    }
    .logo {
      font-size: 22px; font-weight: 800; letter-spacing: -0.03em;
    }
    .logo span { color: var(--accent); }
    .user-pill {
      display: none; align-items: center; gap: 10px;
      background: var(--bg); border: 1px solid var(--border);
      padding: 6px 14px; border-radius: 100px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px; color: var(--muted);
    }
    .user-pill.show { display: flex; }
    .user-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); }
    .logout-btn {
      background: none; border: none; cursor: pointer;
      color: var(--accent); font-size: 11px;
      font-family: 'JetBrains Mono', monospace;
      letter-spacing: 0.05em; padding: 0 0 0 8px;
      border-left: 1px solid var(--border); margin-left: 8px;
    }

    /* â”€â”€ MAIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    main {
      max-width: 520px; margin: 0 auto;
      padding: 60px 20px;
    }

    /* â”€â”€ SCREENS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .screen { display: none; animation: fadeIn 0.4s ease; }
    .screen.active { display: block; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(16px); } to { opacity:1; transform:none; } }

    /* â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .screen-title {
      font-size: 13px; font-weight: 600; letter-spacing: 0.12em;
      text-transform: uppercase; color: var(--muted);
      font-family: 'JetBrains Mono', monospace;
      margin-bottom: 12px;
    }
    h1 { font-size: 42px; font-weight: 800; line-height: 1.05; letter-spacing: -0.03em; margin-bottom: 8px; }
    h1 em { color: var(--accent); font-style: normal; }
    .desc { color: var(--muted); font-size: 15px; margin-bottom: 40px; }

    .form-card {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 36px;
      box-shadow: 4px 4px 0 var(--border);
    }

    .field { margin-bottom: 20px; }
    label {
      display: block;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--muted);
      margin-bottom: 7px;
    }
    input[type="text"], input[type="password"], input[type="email"] {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      color: var(--ink);
      font-family: 'JetBrains Mono', monospace;
      font-size: 14px;
      padding: 12px 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    input:focus {
      border-color: var(--accent);
      box-shadow: 3px 3px 0 rgba(200,75,47,0.15);
    }
    input::placeholder { color: #bbb4a8; }

    .pw-wrap { position: relative; }
    .pw-toggle {
      position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
      background: none; border: none; cursor: pointer;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px; color: var(--muted); letter-spacing: 0.05em;
    }
    .pw-toggle:hover { color: var(--accent); }

    .btn-primary {
      width: 100%; padding: 15px;
      background: var(--accent);
      color: #fff;
      border: 1px solid var(--accent);
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 15px; font-weight: 700;
      letter-spacing: 0.03em;
      cursor: pointer; margin-top: 8px;
      box-shadow: 3px 3px 0 #a03824;
      transition: transform 0.1s, box-shadow 0.1s;
    }
    .btn-primary:hover { transform: translate(-1px,-1px); box-shadow: 4px 4px 0 #a03824; }
    .btn-primary:active { transform: translate(1px,1px); box-shadow: 1px 1px 0 #a03824; }
    .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; box-shadow: 3px 3px 0 #a03824; }

    .alert {
      padding: 11px 14px; margin-top: 16px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px; display: none;
    }
    .alert.show { display: block; }
    .alert.err  { border: 1px solid var(--accent); color: var(--accent); background: rgba(200,75,47,0.06); }
    .alert.ok   { border: 1px solid var(--green);  color: var(--green);  background: rgba(42,122,75,0.06); }

    .spinner {
      display: inline-block; width: 12px; height: 12px;
      border: 2px solid rgba(255,255,255,0.3); border-top-color: #fff;
      border-radius: 50%; animation: spin 0.6s linear infinite;
      vertical-align: middle; margin-right: 8px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* â”€â”€ ORDER SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .iftar-header {
      display: flex; align-items: flex-start; justify-content: space-between;
      margin-bottom: 36px;
    }
    .iftar-header h1 { font-size: 36px; }
    .time-badge {
      background: var(--gold); color: #fff;
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px; letter-spacing: 0.08em;
      padding: 5px 10px; margin-top: 6px;
    }

    .menu-grid {
      display: grid; grid-template-columns: 1fr 1fr;
      gap: 14px; margin-bottom: 32px;
    }
    .menu-item {
      background: var(--surface);
      border: 1px solid var(--border);
      padding: 20px;
      cursor: pointer;
      transition: transform 0.1s, box-shadow 0.1s, border-color 0.2s;
      box-shadow: 2px 2px 0 var(--border);
      position: relative;
    }
    .menu-item:hover { transform: translate(-1px,-1px); box-shadow: 3px 3px 0 var(--border); }
    .menu-item.selected {
      border-color: var(--accent);
      box-shadow: 3px 3px 0 rgba(200,75,47,0.3);
    }
    .menu-item.selected::after {
      content: 'âœ“';
      position: absolute; top: 10px; right: 12px;
      color: var(--accent); font-size: 14px; font-weight: 800;
    }
    .item-emoji { font-size: 28px; margin-bottom: 8px; }
    .item-name { font-size: 14px; font-weight: 700; margin-bottom: 3px; }
    .item-price {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px; color: var(--muted);
    }
    .item-stock {
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px; color: var(--green); margin-top: 4px;
    }
    .item-stock.low { color: var(--accent); }

    .order-summary {
      background: var(--surface); border: 1px solid var(--border);
      padding: 22px; margin-bottom: 20px;
      box-shadow: 3px 3px 0 var(--border);
    }
    .summary-title {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px; letter-spacing: 0.1em; text-transform: uppercase;
      color: var(--muted); margin-bottom: 14px;
    }
    .summary-row {
      display: flex; justify-content: space-between; align-items: center;
      padding: 8px 0; border-bottom: 1px dashed var(--border);
      font-size: 14px;
    }
    .summary-row:last-child { border-bottom: none; font-weight: 700; }
    .summary-none { color: var(--muted); font-size: 13px; font-style: italic; }

    /* â”€â”€ STATUS SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .order-id-tag {
      font-family: 'JetBrains Mono', monospace;
      font-size: 12px; color: var(--muted);
      margin-bottom: 24px;
    }
    .order-id-tag strong { color: var(--accent); }

    .status-track {
      margin: 36px 0;
    }
    .track-step {
      display: flex; align-items: flex-start; gap: 18px;
      padding: 20px 0;
      position: relative;
    }
    .track-step:not(:last-child)::after {
      content: '';
      position: absolute; left: 19px; top: 52px;
      width: 2px; height: calc(100% - 12px);
      background: var(--border);
    }
    .track-step.done:not(:last-child)::after { background: var(--green); }
    .track-step.active:not(:last-child)::after {
      background: linear-gradient(var(--green), var(--border));
    }

    .step-icon {
      width: 40px; height: 40px; border-radius: 50%;
      border: 2px solid var(--border);
      display: flex; align-items: center; justify-content: center;
      font-size: 16px; flex-shrink: 0;
      background: var(--surface);
      transition: all 0.4s;
      position: relative; z-index: 1;
    }
    .track-step.done .step-icon  { border-color: var(--green); background: var(--green); }
    .track-step.active .step-icon {
      border-color: var(--amber); background: var(--amber);
      animation: pulse 1.5s infinite;
    }
    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(224,154,26,0.4); }
      50%       { box-shadow: 0 0 0 10px rgba(224,154,26,0); }
    }

    .step-body { flex: 1; padding-top: 8px; }
    .step-label { font-weight: 700; font-size: 16px; margin-bottom: 3px; }
    .step-desc  { font-size: 13px; color: var(--muted); }
    .step-time  {
      font-family: 'JetBrains Mono', monospace;
      font-size: 11px; color: var(--muted); margin-top: 4px;
    }
    .track-step.pending .step-label { color: var(--muted); font-weight: 400; }

    .ready-banner {
      display: none; text-align: center;
      background: var(--green); color: #fff;
      padding: 28px; margin-top: 20px;
      animation: popIn 0.5s cubic-bezier(0.34,1.56,0.64,1);
    }
    .ready-banner.show { display: block; }
    @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    .ready-banner .big { font-size: 40px; margin-bottom: 8px; }
    .ready-banner h2  { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
    .ready-banner p   { font-size: 14px; opacity: 0.85; }

    .new-order-btn {
      width: 100%; padding: 14px;
      background: transparent;
      color: var(--ink); border: 1px solid var(--border);
      font-family: 'Bricolage Grotesque', sans-serif;
      font-size: 14px; font-weight: 600;
      cursor: pointer; margin-top: 24px;
      transition: background 0.2s;
    }
    .new-order-btn:hover { background: var(--surface); }

    /* â”€â”€ WS indicator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .ws-pill {
      display: inline-flex; align-items: center; gap: 6px;
      font-family: 'JetBrains Mono', monospace;
      font-size: 10px; color: var(--muted);
      padding: 4px 10px; border: 1px solid var(--border);
      margin-bottom: 24px;
    }
    .ws-dot { width: 6px; height: 6px; border-radius: 50%; background: #ccc; }
    .ws-dot.connected { background: var(--green); animation: pulse 2s infinite; }
    .ws-dot.error     { background: var(--accent); }
  </style>
</head>
<body>

<header>
  <div class="logo">IUT <span>Iftar</span></div>
  <div class="user-pill" id="userPill">
    <div class="user-dot"></div>
    <span id="userEmail">â€”</span>
    <button class="logout-btn" onclick="logout()">LOGOUT</button>
  </div>
</header>

<main>

  <!-- â”€â”€ SCREEN: LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="screen active" id="screen-login">
    <div class="screen-title">// Student Portal</div>
    <h1>Break the<br/><em>Fast,</em> Not<br/>the Server.</h1>
    <p class="desc">Login with your IUT credentials to place your Iftar order.</p>

    <div class="form-card">
      <div class="field">
        <label>Student Email</label>
        <input type="email" id="loginEmail" placeholder="student@iut-dhaka.edu"/>
      </div>
      <div class="field">
        <label>Password</label>
        <div class="pw-wrap">
          <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"/>
          <button class="pw-toggle" id="pwToggle">SHOW</button>
        </div>
      </div>
      <button class="btn-primary" id="loginBtn" onclick="handleLogin()">LOGIN â†’</button>
      <div class="alert" id="loginAlert"></div>
    </div>
  </div>

  <!-- â”€â”€ SCREEN: ORDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="screen" id="screen-order">
    <div class="iftar-header">
      <div>
        <div class="screen-title">// Iftar Menu</div>
        <h1>Choose Your<br/><em>Iftar</em> Pack</h1>
      </div>
      <div class="time-badge" id="countdownBadge">5:30 PM</div>
    </div>

    <div class="menu-grid" id="menuGrid">
      <!-- injected by JS -->
    </div>

    <div class="order-summary" id="orderSummary">
      <div class="summary-title">Order Summary</div>
      <div class="summary-none" id="summaryEmpty">No items selected</div>
      <div id="summaryItems"></div>
    </div>

    <button class="btn-primary" id="placeOrderBtn" onclick="placeOrder()" disabled>
      PLACE ORDER â†’
    </button>
    <div class="alert" id="orderAlert"></div>
  </div>

  <!-- â”€â”€ SCREEN: STATUS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="screen" id="screen-status">
    <div class="screen-title">// Live Order Tracker</div>
    <h1>Your <em>Iftar</em><br/>is on the way!</h1>

    <div class="order-id-tag">
      Order ID: <strong id="displayOrderId">â€”</strong>
    </div>

    <div class="ws-pill">
      <div class="ws-dot" id="wsDot"></div>
      <span id="wsStatus">Connecting...</span>
    </div>

    <div class="status-track" id="statusTrack">
      <div class="track-step" id="step-pending">
        <div class="step-icon">â³</div>
        <div class="step-body">
          <div class="step-label">Pending</div>
          <div class="step-desc">Order received by gateway</div>
          <div class="step-time" id="time-pending"></div>
        </div>
      </div>
      <div class="track-step" id="step-stock">
        <div class="step-icon">ğŸ“¦</div>
        <div class="step-body">
          <div class="step-label">Stock Verified</div>
          <div class="step-desc">Inventory confirmed & reserved</div>
          <div class="step-time" id="time-stock"></div>
        </div>
      </div>
      <div class="track-step" id="step-kitchen">
        <div class="step-icon">ğŸ‘¨â€ğŸ³</div>
        <div class="step-body">
          <div class="step-label">In Kitchen</div>
          <div class="step-desc">Bhaiya is cooking your food!</div>
          <div class="step-time" id="time-kitchen"></div>
        </div>
      </div>
      <div class="track-step" id="step-ready">
        <div class="step-icon">âœ…</div>
        <div class="step-body">
          <div class="step-label">Ready</div>
          <div class="step-desc">Collect from counter B</div>
          <div class="step-time" id="time-ready"></div>
        </div>
      </div>
    </div>

    <div class="ready-banner" id="readyBanner">
      <div class="big">ğŸ‰</div>
      <h2>Iftar Ready!</h2>
      <p>Please collect your order from Counter B. Ramadan Mubarak!</p>
    </div>

    <button class="new-order-btn" onclick="goToOrder()">â† Place Another Order</button>
  </div>

</main>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CONFIG â€” change ports to match your backend
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const API = {
  identity: 'http://localhost:5000',   // Identity Provider
  gateway:  'http://localhost:5002',   // Order Gateway
  stock:    'http://localhost:5003',   // Stock Service
  notif:    'ws://localhost:5005',     // Notification Hub (WebSocket)
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• STATE */
let token     = localStorage.getItem('iut_token') || null;
let userEmail = localStorage.getItem('iut_email') || null;
let ws        = null;
let currentOrderId = null;
let selectedItem   = null;

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MENU DATA */
const MENU = [
  { id: 'iftar-pack-a', emoji: 'ğŸ±', name: 'Iftar Pack A', price: 85, desc: 'Date, Piyaju, Halim, Khichuri' },
  { id: 'iftar-pack-b', emoji: 'ğŸ¥˜', name: 'Iftar Pack B', price: 95, desc: 'Date, Beguni, Chola, Rice' },
  { id: 'iftar-pack-c', emoji: 'ğŸ²', name: 'Special Halim', price: 70, desc: 'Full bowl with naan' },
  { id: 'iftar-pack-d', emoji: 'ğŸ§†', name: 'Snack Box',    price: 50, desc: 'Piyaju, Samosa, Beguni' },
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• INIT */
window.addEventListener('DOMContentLoaded', () => {
  // password toggle
  document.getElementById('pwToggle').addEventListener('click', () => {
    const inp = document.getElementById('loginPassword');
    const isHidden = inp.type === 'password';
    inp.type = isHidden ? 'text' : 'password';
    document.getElementById('pwToggle').textContent = isHidden ? 'HIDE' : 'SHOW';
  });

  // enter key
  document.addEventListener('keydown', e => {
    if (e.key === 'Enter') {
      if (showingScreen('login')) handleLogin();
    }
  });

  // restore session
  if (token && userEmail) {
    showUserPill(userEmail);
    buildMenu();
    showScreen('order');
  }
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• HELPERS */
function showScreen(name) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById('screen-' + name).classList.add('active');
}
function showingScreen(name) {
  return document.getElementById('screen-' + name).classList.contains('active');
}
function showAlert(id, msg, type) {
  const el = document.getElementById(id);
  el.textContent = msg;
  el.className = `alert show ${type}`;
}
function hideAlert(id) {
  document.getElementById(id).className = 'alert';
}
function setBtn(id, html, disabled = false) {
  const b = document.getElementById(id);
  b.innerHTML = html;
  b.disabled = disabled;
}
function showUserPill(email) {
  document.getElementById('userEmail').textContent = email;
  document.getElementById('userPill').classList.add('show');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• LOGIN */
async function handleLogin() {
  const email    = document.getElementById('loginEmail').value.trim();
  const password = document.getElementById('loginPassword').value;
  if (!email || !password) { showAlert('loginAlert', 'Email à¦“ password à¦¦à¦¿à¦¨à¥¤', 'err'); return; }

  setBtn('loginBtn', '<span class="spinner"></span>LOGGING IN...', true);
  hideAlert('loginAlert');

  try {
    const res  = await fetch(`${API.identity}/login`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password }),
    });
    const data = await res.json();

    if (!res.ok) {
      showAlert('loginAlert', data.message || 'Login failed.', 'err');
      return;
    }

    token     = data.token;
    userEmail = email;
    localStorage.setItem('iut_token', token);
    localStorage.setItem('iut_email', userEmail);

    showUserPill(email);
    showAlert('loginAlert', 'Login successful!', 'ok');
    setTimeout(() => { buildMenu(); showScreen('order'); }, 800);

  } catch(e) {
    showAlert('loginAlert', 'Server connect à¦•à¦°à¦¾ à¦¯à¦¾à¦šà§à¦›à§‡ à¦¨à¦¾à¥¤', 'err');
  } finally {
    setBtn('loginBtn', 'LOGIN â†’', false);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• MENU */
async function buildMenu() {
  const grid = document.getElementById('menuGrid');
  grid.innerHTML = '';

  // Try to fetch live stock from Stock Service
  let stockMap = {};
  try {
    const res = await fetch(`${API.stock}/stock`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (res.ok) {
      const data = await res.json();
      stockMap = data; // e.g. { 'iftar-pack-a': 42, ... }
    }
  } catch(e) { /* fallback: show without stock */ }

  MENU.forEach(item => {
    const stock = stockMap[item.id] ?? 99;
    const low   = stock < 10 && stock > 0;
    const out   = stock === 0;
    const card  = document.createElement('div');
    card.className = 'menu-item' + (out ? ' out' : '');
    card.id = 'menu-' + item.id;
    card.innerHTML = `
      <div class="item-emoji">${item.emoji}</div>
      <div class="item-name">${item.name}</div>
      <div class="item-price">à§³${item.price}</div>
      <div class="item-stock ${low ? 'low' : ''}">${out ? 'âœ— Out of Stock' : low ? `âš  Only ${stock} left` : `âœ“ In Stock`}</div>
    `;
    if (!out) card.onclick = () => selectItem(item);
    else card.style.opacity = '0.4';
    grid.appendChild(card);
  });
}

function selectItem(item) {
  document.querySelectorAll('.menu-item').forEach(c => c.classList.remove('selected'));
  document.getElementById('menu-' + item.id)?.classList.add('selected');
  selectedItem = item;
  updateSummary();
  document.getElementById('placeOrderBtn').disabled = false;
}

function updateSummary() {
  if (!selectedItem) return;
  document.getElementById('summaryEmpty').style.display = 'none';
  document.getElementById('summaryItems').innerHTML = `
    <div class="summary-row"><span>${selectedItem.emoji} ${selectedItem.name}</span><span>à§³${selectedItem.price}</span></div>
    <div class="summary-row"><span>Service Fee</span><span>à§³5</span></div>
    <div class="summary-row"><span>Total</span><span>à§³${selectedItem.price + 5}</span></div>
  `;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• PLACE ORDER */
async function placeOrder() {
  if (!selectedItem) return;
  setBtn('placeOrderBtn', '<span class="spinner"></span>PLACING ORDER...', true);
  hideAlert('orderAlert');

  try {
    const res = await fetch(`${API.gateway}/order`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${token}`,
      },
      body: JSON.stringify({ itemId: selectedItem.id, quantity: 1 }),
    });
    const data = await res.json();

    if (res.status === 401) { showAlert('orderAlert', 'Session expired. Please login again.', 'err'); logout(); return; }
    if (!res.ok) { showAlert('orderAlert', data.message || 'Order failed.', 'err'); return; }

    currentOrderId = data.orderId;
    startTracking(currentOrderId);
    showScreen('status');

  } catch(e) {
    showAlert('orderAlert', 'Gateway unreachable.', 'err');
  } finally {
    setBtn('placeOrderBtn', 'PLACE ORDER â†’', false);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• WEBSOCKET TRACKING */
const STEPS = ['pending', 'stock', 'kitchen', 'ready'];
const STEP_ICONS = { pending:'â³', stock:'ğŸ“¦', kitchen:'ğŸ‘¨â€ğŸ³', ready:'âœ…' };
let currentStepIdx = 0;

function startTracking(orderId) {
  document.getElementById('displayOrderId').textContent = orderId;
  resetSteps();
  setStep('pending', 'done');

  // Connect WebSocket for real-time updates
  connectWS(orderId);
}

function resetSteps() {
  currentStepIdx = 0;
  STEPS.forEach(s => {
    const el = document.getElementById('step-' + s);
    el.className = 'track-step pending';
    el.querySelector('.step-icon').textContent = STEP_ICONS[s];
    document.getElementById('time-' + s).textContent = '';
  });
  document.getElementById('readyBanner').classList.remove('show');
}

function setStep(stepId, state) {
  const el   = document.getElementById('step-' + stepId);
  const time = document.getElementById('time-' + stepId);
  el.className = `track-step ${state}`;
  time.textContent = new Date().toLocaleTimeString('en-BD', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
  if (state === 'done') el.querySelector('.step-icon').textContent = 'âœ“';
  if (state === 'active') el.querySelector('.step-icon').textContent = STEP_ICONS[stepId];
}

function advanceToStep(status) {
  // Map backend status strings to step IDs
  const map = {
    'PENDING':        'pending',
    'STOCK_VERIFIED': 'stock',
    'IN_KITCHEN':     'kitchen',
    'READY':          'ready',
    // alternate keys
    'pending':        'pending',
    'stock_verified': 'stock',
    'in_kitchen':     'kitchen',
    'ready':          'ready',
  };
  const stepId = map[status];
  if (!stepId) return;

  const idx = STEPS.indexOf(stepId);
  STEPS.forEach((s, i) => {
    if (i < idx)  setStep(s, 'done');
    if (i === idx) setStep(s, i === STEPS.length - 1 ? 'done' : 'active');
    // else pending
  });

  if (stepId === 'ready') {
    document.getElementById('readyBanner').classList.add('show');
    ws?.close();
  }
}

function connectWS(orderId) {
  const dot    = document.getElementById('wsDot');
  const label  = document.getElementById('wsStatus');
  dot.className = 'ws-dot';
  label.textContent = 'Connecting...';

  try {
    ws = new WebSocket(`${API.notif}?orderId=${orderId}&token=${token}`);

    ws.onopen = () => {
      dot.className = 'ws-dot connected';
      label.textContent = 'Live â€” receiving updates';
    };

    ws.onmessage = (e) => {
      try {
        const msg = JSON.parse(e.data);
        // Expected: { orderId, status: 'PENDING'|'STOCK_VERIFIED'|'IN_KITCHEN'|'READY' }
        if (msg.orderId === orderId || !msg.orderId) {
          advanceToStep(msg.status);
        }
      } catch(_) {}
    };

    ws.onerror = () => {
      dot.className = 'ws-dot error';
      label.textContent = 'WebSocket error â€” polling fallback';
      startPolling(orderId); // fallback
    };

    ws.onclose = () => {
      if (dot.className.includes('connected')) {
        dot.className = 'ws-dot';
        label.textContent = 'Disconnected';
      }
    };

  } catch(e) {
    dot.className = 'ws-dot error';
    label.textContent = 'WS unavailable â€” using polling';
    startPolling(orderId);
  }
}

/* â”€â”€ Polling fallback if WS unavailable â”€â”€ */
let pollInterval = null;
function startPolling(orderId) {
  clearInterval(pollInterval);
  pollInterval = setInterval(async () => {
    try {
      const res = await fetch(`${API.gateway}/order/${orderId}/status`, {
        headers: { 'Authorization': `Bearer ${token}` }
      });
      if (res.ok) {
        const data = await res.json();
        advanceToStep(data.status);
        if (data.status === 'READY' || data.status === 'ready') clearInterval(pollInterval);
      }
    } catch(_) {}
  }, 3000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• NAV */
function goToOrder() {
  ws?.close();
  clearInterval(pollInterval);
  selectedItem = null;
  document.getElementById('placeOrderBtn').disabled = true;
  document.getElementById('summaryEmpty').style.display = 'block';
  document.getElementById('summaryItems').innerHTML = '';
  document.querySelectorAll('.menu-item').forEach(c => c.classList.remove('selected'));
  buildMenu();
  showScreen('order');
}

function logout() {
  token = userEmail = null;
  localStorage.removeItem('iut_token');
  localStorage.removeItem('iut_email');
  ws?.close();
  clearInterval(pollInterval);
  document.getElementById('userPill').classList.remove('show');
  document.getElementById('loginEmail').value    = '';
  document.getElementById('loginPassword').value = '';
  hideAlert('loginAlert');
  showScreen('login');
}
</script>
</body>
</html>